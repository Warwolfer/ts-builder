<!DOCTYPE html>
<html>
<head>
    <title>Banner URL Test</title>
    <script src="shared/build-encoder.js"></script>
</head>
<body>
    <h1>Build Code Test</h1>
    <button onclick="testBannerEncoding()">Test New Format</button>
    <button onclick="testOldFormat()">Test Old Format Compatibility</button>
    <button onclick="compareCompactFormat()">Compare Compact vs Regular</button>
    <div id="results"></div>

    <script>
        function testBannerEncoding() {
            const testState = {
                chosenMasteries: ['weapon-arts', 'evoke'],
                chosenMasteriesRanks: [3, 4],
                armorType: 'medium',
                armorRank: 2,
                weaponRank: 3,
                chosenActions: ['action1', 'action2'],
                characterName: 'Test Character',
                characterRace: 'Human',
                characterTitle: 'Sword Master',
                threadCode: 'TEST123',
                profileBannerUrl: 'https://terrarp.com/data/avatars/l/123/banner.jpg'
            };

            // Test encoding
            const encoded = BuildEncoder.generateBuildCode(testState);
            console.log('Encoded:', encoded);

            // Test decoding
            const result = BuildEncoder.decodeBuildCode(encoded);
            console.log('Decoded result:', result);
            
            // Debug the split operation
            const hashPart = encoded.split('#import.')[1];
            const decoded = atob(hashPart);
            const parts = decoded.split('|');
            console.log('Decoded string:', decoded);
            console.log('Parts after split:', parts);
            console.log('Part 10 (banner URL):', parts[10]);

            const resultsDiv = document.getElementById('results');
            if (result.success) {
                resultsDiv.innerHTML = `
                    <h3>Success!</h3>
                    <p><strong>Original Name:</strong> ${testState.characterName} | <strong>Decoded:</strong> ${result.data.characterName}</p>
                    <p><strong>Original Race:</strong> ${testState.characterRace} | <strong>Decoded:</strong> ${result.data.characterRace}</p>
                    <p><strong>Original Title:</strong> ${testState.characterTitle} | <strong>Decoded:</strong> ${result.data.characterTitle}</p>
                    <p><strong>Original Banner URL:</strong> ${testState.profileBannerUrl}</p>
                    <p><strong>Decoded Banner URL:</strong> ${result.data.profileBannerUrl}</p>
                    <p><strong>URLs Match:</strong> ${testState.profileBannerUrl === result.data.profileBannerUrl}</p>
                    <p><strong>Encoded URL:</strong> ${encoded}</p>
                    <hr>
                    <h4>Debug Info:</h4>
                    <p><strong>Decoded string:</strong> ${decoded}</p>
                    <p><strong>Parts count:</strong> ${parts.length}</p>
                    <p><strong>Part 10 (raw):</strong> ${parts[10] || 'undefined'}</p>
                    <p><strong>Part 10 (decoded):</strong> ${parts[10] ? decodeURIComponent(parts[10]) : 'undefined'}</p>
                `;
            } else {
                resultsDiv.innerHTML = `<h3>Error:</h3><p>${result.error}</p>`;
            }
        }
        
        function testOldFormat() {
            // Test with an old format build code (dot-delimited, no race/title)
            const oldFormatCode = 'https://terrarp.com/build/build-sheet.html#import.d2VhcG9uLWFydHMsZXZva2UuMyw0Lm1lZGl1bS4yLjMuYWN0aW9uMSxhY3Rpb24yLlRlc3RfQ2hhcmFjdGVyLlRFU1QxMjM=';
            
            const result = BuildEncoder.decodeBuildCode(oldFormatCode);
            console.log('Old format result:', result);
            
            const resultsDiv = document.getElementById('results');
            if (result.success) {
                resultsDiv.innerHTML = `
                    <h3>Old Format Compatibility Test Success!</h3>
                    <p><strong>Name:</strong> ${result.data.characterName}</p>
                    <p><strong>Race:</strong> ${result.data.characterRace || 'Not set (expected)'}</p>
                    <p><strong>Title:</strong> ${result.data.characterTitle || 'Not set (expected)'}</p>
                    <p><strong>Thread Code:</strong> ${result.data.threadCode}</p>
                    <p><strong>Banner URL:</strong> ${result.data.profileBannerUrl || 'Not set'}</p>
                `;
            } else {
                resultsDiv.innerHTML = `<h3>Old Format Error:</h3><p>${result.error}</p>`;
            }
        }
        
        function compareCompactFormat() {
            // Load masteries first 
            if (!window.masterylist) {
                // Simple mock for testing
                window.masterylist = [
                    {id: 17, lookup: 'animancy'},
                    {id: 15, lookup: 'slash-weapons'}, 
                    {id: 5, lookup: 'astramancy'},
                    {id: 20, lookup: 'harmonic-magic'},
                    {id: 31, lookup: 'metamorph'}
                ];
            }
            
            const testState = {
                chosenMasteries: ['animancy', 'slash-weapons', 'astramancy', 'harmonic-magic', 'metamorph'],
                chosenMasteriesRanks: [5, 5, 5, 5, 5],
                armorType: 'heavy',
                armorRank: 5,
                weaponRank: 5,
                chosenActions: ['versatile', 'protect', 'ultra-protect', 'torment', 'damage'],
                characterName: 'Lune',
                characterRace: 'Human',
                characterTitle: '❮ Steel Reclaimer ❯'
            };
            
            // Generate both formats
            const regular = BuildEncoder.generateBuildCode(testState);
            const compact = BuildEncoder.generateCompactBuildCode(testState);
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h3>Format Comparison</h3>
                <h4>Regular Format:</h4>
                <p><strong>Length:</strong> ${regular.length} characters</p>
                <p><strong>URL:</strong> <small>${regular}</small></p>
                
                <h4>Compact Format:</h4>
                <p><strong>Length:</strong> ${compact.length} characters</p>
                <p><strong>URL:</strong> <small>${compact}</small></p>
                
                <h4>Savings:</h4>
                <p><strong>Size reduction:</strong> ${regular.length - compact.length} characters (${Math.round((1 - compact.length/regular.length) * 100)}% smaller)</p>
            `;
        }
    </script>
</body>
</html>