<!DOCTYPE html>
<html>
<head>
  <title>TerraSphere Build Editor - Character Build V2</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/app.css">
  <link rel="stylesheet" href="css/index.css">
  <style>
    /* Thread code input styling */
    .header-info--functions {
      display: block !important;
      float: right;
      width: 160px;
    }
    
    #inputbox {
      display: block !important;
      padding: 10px 0px;
    }
    
    #threadcodereplace {
      width: 100% !important;
      height: 40px !important;
      padding: 10px !important;
      font-size: 14px !important;
      border: 2px solid #fff !important;
      border-radius: 6px !important;
      background: linear-gradient(0deg, rgba(17,20,28,0.95) 0%, rgba(17,20,28,0.85) 100%) !important;
      color: #fff !important;
      box-sizing: border-box !important;
      display: block !important;
    }
    
    #threadcodereplace:focus {
      outline: none !important;
      border-color: #a9357b !important;
      box-shadow: 0 0 5px rgba(71, 203, 221, 0.3) !important;
    }
  </style>
  <link rel="shortcut icon" href="https://www.terrarp.com//favicon.ico">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  
  <!-- Shared modules -->
  <script src="shared/state-manager.js"></script>
  <script src="shared/dom-utils.js"></script>
  <script src="shared/data-loader.js"></script>
  <script src="shared/calculations.js"></script>
  <script src="shared/build-encoder.js"></script>
  <script src="shared/loading-manager.js"></script>
  
  <!-- Data files -->
  <script src="resource/masteries.js"></script>
  <script src="resource/expertise.js"></script>
  <script src="resource/actions.js"></script>
  <script src="resource/safecharacters.js"></script>
  <script src="resource/armor-abilities.js"></script>
</head>

<body>
  <nav id="mw-navigation" class="fixed-top">
    <div class="container">
      <a href="https://terrarp.com/build/" class="navbar-brand">
        <img src="https://terrarp.com/db/logo/logo-xs.png">
      </a>
      <div class="nav-left">
        <div class="link"><a href="https://terrarp.com/build/index.html" style="color:#47cbdd">Build Planner</a></div>
        <div class="link"><a href="https://terrarp.com/build/v2/index.html" style="color:#47cbdd">V2 Beta</a></div>
        <div class="link"><a href="https://terrarp.com/index.php">Forums</a></div>
        <div class="link"><a href="https://terrarp.com/wiki/Main_Page">Wiki</a></div>
        <div class="dropdown">
          <button class="dropbtn">Important <i class="fa fa-caret-down"></i></button>
          <div class="dropdown-content">
            <a href="https://terrarp.com/wiki/Mastery">Mastery List</a>
            <a href="https://terrarp.com/wiki/Races">Playable Races</a>
            <a href="https://terrarp.com/wiki/RPG_Mechanics">RPG Mechanics</a>
            <a href="https://terrarp.com/wiki/Actions">Action List</a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div id="bodyback">
    <div id="builddisplay">
      <!-- Masteries Display -->
      <div class="banner">
        <div class="bannerstuff">
          <div class="bannercontent">
            <div class="charimg2 left">
              <div class="avatar-container">
                <img id="pfp2">
                <div class="rank-badge-avatar" id="rank-badge-avatar">E</div>
              </div>
            </div>
            <div class="charcontainer left">
            <span class="nameheader header-info--nameheader characterstuff">
              <span class="charname" id="character-name-display">Character Build</span>
              <span class="chartitle" id="character-title-display"></span>
<!--              <span class="charrace" id="character-race-display"></span>-->
            </span>
            </div>
            <div class="filler"></div>
            <div class="header-info--functions right">
              <div class="masterycategory" id="inputbox">
                <input type="text" id="threadcodereplace" autocomplete="off" placeholder="Thread code (510C5)...">
              </div>
              <div id="finalbuild"></div>
            </div>
          </div>
          <div class="filler"></div>

          <div class="masterycategory" id="statsdisplay">
            <div class="hpdisplay"></div>
            <div class="movementdisplay"></div>
            <div class="rangedisplay"></div>
          </div>
        </div>
      </div>

      <!-- Equipment and Saves Display -->
      <div class="equipment-saves-container">
        <div class="equipment-section">
          <h1 class="statheader">Equipment</h1>
          <div class="masterycategory mastery-margin" id="equipmentdisplay">
            <div class="weaponrankdisplay"></div>
            <div class="armorrankdisplay"></div>
            <div class="accessoryrankdisplay"></div>
          </div>
        </div>
        
        <div class="saves-section">
          <h1 class="statheader">Saves</h1>
          <div class="masterycategory mastery-margin" id="savesdisplay">
            <div class="fortitudesavedisplay"></div>
            <div class="reflexsavedisplay"></div>
            <div class="willsavedisplay"></div>
          </div>
        </div>
      </div>

      <!-- Mastery and Expertise Display -->
      <div class="mastery-expertise-container">
        <div class="mastery-section">
          <h1 class="statheader">Mastery</h1>
          <div class="masterycategory mastery-margin" id="masterydisplay"></div>
        </div>
        
        <div class="expertise-section">
          <h1 class="statheader">Expertise</h1>
          <div class="masterycategory mastery-margin" id="expertisedisplay"></div>
        </div>
      </div>


      <div class="masterycategory" id="equipmentpassive" style="margin-top:0">
        <div class="edisplay armorskilldisplay">
          <div class="passivecontainer">
            <span class='armorpassive'></span>
          </div>
        </div>
      </div>

      <!-- Saves and Checks -->
      <h3 class="selectorheader" id="savechecklabel">Saves and Checks
        <span class="ttip" data-tooltip="Click on the small icons at the bottom of the following cards to automatically apply the bonus and type name to the Discord roll code.">
          <span class="ttip-info"></span><i class="far fa-question-circle tip"></i>
        </span>
      </h3>
      <div class="masterycategory" id="saveschecks">
        <div class="card">
          <div class="cardtitle">Saves</div>
          <div class="rollcode">?r save <span class='saveadv'></span><span class='savebonusreplace'>X</span> <span class='reflexmodifiers'></span> # <span class='savereplace'>Type</span> | Character Name | <span class="thrcode">Thread Code</span></div>
          <div id="savesicons">
            <div class='display masterycircle aci-fortitude' onclick='clickFortitude(this)'>
              <img src='https://terrarp.com/db/tool/fortitude.png'>
            </div>
            <div class='display masterycircle aci-reflex' onclick='clickReflex(this)'>
              <img src='https://terrarp.com/db/tool/reflex.png'>
            </div>
            <div class='display masterycircle aci-will' onclick='clickWill(this)'>
              <img src='https://terrarp.com/db/tool/will.png'>
            </div>
          </div>
          <div class="togglecontainer">
            <div class="togglesavechecks" onclick="advantageSave()">Adv</div>
            <div class="togglesavechecks" onclick="normalSave()">Normal</div>
            <div class="togglesavechecks" onclick="disadvantageSave()">Dis</div>
          </div>
        </div>
        <div class="card">
          <div class="cardtitle">Expertise Check</div>
          <div class="rollcode">?r expertise <span class='expertiseadv'></span><span class='expertisebonusreplace'>ER</span> # <span class='expertisereplace'>Type</span> | Character Name | <span class="thrcode">Thread Code</span></div>
          <div id="expertiseicons">
            <!-- V2 expertise icons will be populated by JavaScript based on selected expertise -->
          </div>
          <div class="togglecontainer">
            <div class="togglesavechecks" onclick="advantageExpertise()">Adv</div>
            <div class="togglesavechecks" onclick="normalExpertise()">Normal</div>
            <div class="togglesavechecks" onclick="disadvantageExpertise()">Dis</div>
          </div>
        </div>
        <div class="card">
          <div class="cardtitle">Mastery Check</div>
          <div class="rollcode">?r mastery <span class='masteryadv'></span><span class='masteryreplace'>MR</span> # <span class='mnamereplace'>Type</span> | Character Name | <span class="thrcode">Thread Code</span></div>
          <div id="masterycheckicons"></div>
          <div class="togglecontainer">
            <div class="togglesavechecks" onclick="advantageMastery()">Adv</div>
            <div class="togglesavechecks" onclick="normalMastery()">Normal</div>
            <div class="togglesavechecks" onclick="disadvantageMastery()">Dis</div>
          </div>
        </div>
      </div>

      <!-- Actions Display -->
      <h3 class="selectorheader">Actions</h3>
      <div class="masterycategory" id="freeactiondisplay">
        <!-- Free actions -->
        <div class="card normal">
          <div class="cardicon" style="background-color: #1e2131; background-image: url('https://terrarp.com/db/action/attack.png'); background-repeat: no-repeat; background-position: center;"></div>
          <div class="cardtitle">Attack</div>
          <div class="cardinfo">
            <p><em><b>Basic</b></em></p>
            <p>Perform a basic attack.</p>
          </div>
          <div class="cardroll"><b>Roll:</b> 1d100 + MR + WR + other bonuses</div>
        </div>
        <div class="card rushfinal">
          <div class="cardicon" style="background-color: #1e2131; background-image: url('https://terrarp.com/db/action/rush.png'); background-repeat: no-repeat; background-position: center; background-size: contain;"></div>
          <div class="cardtitle">Rush</div>
          <div class="cardinfo">
            <p><em><b>Basic</b></em></p>
            <p><b>Bonus.</b> Gain 2 extra movements this cycle.</p>
          </div>
          <div class="rollcode rushrc">?r rush # Character Name | <span class="thrcode">Code</span></div>
        </div>
      </div>
      <div class="masterycategory" id="actionsdisplay"></div>

      <!-- Note -->
      <div class="masterycategory" id="notedisplay">
        <div class="note">
          <div class="share-options">
            <div class="share-option">
              <textarea id="note" placeholder="Enter any note here..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Build Code Display -->
      <div class="masterycategory" id="buildcodedisplay">
        <div class="build-sharing">
          <div class="share-options">
            <div class="share-option">
              <label>Build URL:</label>
              <textarea id="build-url" readonly></textarea>
              <button class="copy-button" data-target="build-url">Copy</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="button-container">
      <div class="button" id="back-button">< Select Actions</div>
      <div class="button" id="edit-build-button">Edit This Build</div>
    </div>
  </div>

  <script>
    // Initialize global objects
    window.buildState = window.buildState || new BuildState();
    window.DataLoader = window.DataLoader || new DataLoader();
    window.DOMUtils = window.DOMUtils || new DOMUtils();
    
    // Build Sheet Display Logic for V2
    class BuildSheetV2 {
      constructor() {
        this.state = window.buildState;
        this.dataLoader = window.DataLoader;
        this.domUtils = window.DOMUtils;
        this.calculations = window.CharacterCalculations;
        this.buildEncoder = window.BuildEncoder;
        
        this.armorImages = {
          heavy: 'https://terrarp.com/db/tool/armor-heavy.png',
          medium: 'https://terrarp.com/db/tool/armor-medium.png',
          light: 'https://terrarp.com/db/tool/armor-light.png'
        };

        // Using armor images as placeholders for accessories
        this.accessoryImages = {
          combat: 'https://terrarp.com/db/tool/armor-heavy.png',
          utility: 'https://terrarp.com/db/tool/armor-medium.png',
          magic: 'https://terrarp.com/db/tool/armor-light.png'
        };
        
        this.rankLabels = ['E', 'D', 'C', 'B', 'A', 'S'];
        
        // Helper method to safely get rank label
        this.getRankLabel = (rank) => {
          if (rank < 0 || rank >= this.rankLabels.length) {
            return 'E';
          }
          return this.rankLabels[rank];
        };
        
        this.init();
      }
      
      getRankColorClass(rank) {
        // Handle undefined or invalid rank values
        if (!rank || typeof rank !== 'string') {
          return 'rank-e'; // Default to gray
        }
        
        switch (rank.toUpperCase()) {
          case 'S': return 'rank-s'; // Gold
          case 'A': return 'rank-a'; // Orange  
          case 'B': return 'rank-b'; // Pink
          case 'C': return 'rank-c'; // Green
          case 'D': return 'rank-d'; // Blue
          case 'E': return 'rank-e'; // Grey
          default: return 'rank-e';  // Default to gray
        }
      }
      
      init() {
        try {
          
          // Load V2 data
          this.loadMasteriesV2();
          this.loadExpertiseV2();
          this.loadActionsV2();
          
          // Show the build display (it's hidden by default in app.css)
          const buildDisplay = this.domUtils.getElementById('builddisplay');
          if (buildDisplay) {
            buildDisplay.style.display = 'block';
          }
          
          // Load state from URL if present
          this.state.loadFromURL();
          
          // Check for build code in URL hash
          this.loadFromBuildCode();
          
          // Check if we have a complete build
          if (!this.state.isValidForBuildSheet()) {
            alert('Please complete all previous steps first.');
            window.location.href = this.state.generateURL('mastery-selector.html');
            return;
          }
          
          // Calculate and display everything
          this.displayBuild();
          
          // Set up event listeners
          this.setupEventListeners();
          
          
        } catch (error) {
          console.error('BuildSheet V2: Initialization failed:', error);
          this.showError('Failed to load build data: ' + error.message);
        }
      }
      
      loadMasteriesV2() {
        if (window.masteriesV2) {
          this.dataLoader.cache.masteries = window.masteriesV2;
        } else {
          throw new Error('masteriesV2 not found');
        }
      }
      
      loadExpertiseV2() {
        if (window.expertiseV2) {
          this.dataLoader.cache.expertise = window.expertiseV2;
        } else {
          throw new Error('expertiseV2 not found');
        }
      }
      
      loadActionsV2() {
        if (window.actionlistV2) {
          this.dataLoader.cache.actions = window.actionlistV2;
        } else {
          throw new Error('actionlistV2 not found');
        }
      }
      
      displayBuild() {
        const currentState = this.state.getState();
        const masteries = this.dataLoader.cache.masteries;
        const expertise = this.dataLoader.cache.expertise;
        const actions = this.dataLoader.cache.actions;
        
        // Display character name and banner
        this.displayCharacterName(currentState.characterName);
        this.displayCharacterTitle(currentState.characterTitle);
        this.displayBanner(currentState);
        this.displayCharacterRace(currentState.characterRace);
        this.displayAvatar(currentState.avatarUrl);
        
        // Display note
        this.displayNote(currentState.note);
        
        // Display masteries (6 instead of 5)
        this.displayMasteries(currentState, masteries);
        
        // Display expertise
        this.displayExpertise(currentState, expertise);
        
        // Calculate and display stats
        const stats = this.calculations.getCompleteStats(currentState, masteries, actions, expertise);
        this.displayStats(stats);
        
        // Display equipment
        this.displayEquipment(currentState);
        
        // Display actions
        this.displayActions(currentState, actions);
        
        // Generate build codes
        this.generateBuildCodes(currentState);
        
        // Replace character name in all roll codes
        this.replaceCharacterName(currentState.characterName);
        
        // Replace weapon rank (WR) in all roll codes
        this.replaceWeaponRank(currentState.weaponRank);
        
        // Set up thread code functionality
        this.setupThreadCode();
        this.restoreThreadCode();
        
        // Hide navigation for imported characters
        this.adjustNavigationForImportedCharacter();
      }
      
      displayCharacterName(name) {
        const displayName = name || 'Character Build V2';
        this.domUtils.setText(this.domUtils.getElementById('character-name-display'), displayName);
      }

      displayCharacterRace(race) {
        const displayRace = race || '';
        this.domUtils.setText(this.domUtils.getElementById('character-race-display'), displayRace);
      }

      displayCharacterTitle(title) {
        const displayTitle = title || '';
        this.domUtils.setText(this.domUtils.getElementById('character-title-display'), displayTitle);
      }
      
      displayNote(note) {
        const noteTextarea = this.domUtils.getElementById('note');
        if (noteTextarea) {
          noteTextarea.value = note || '';
        }
      }

      displayAvatar(avatarUrl) {
        const avatarImg = this.domUtils.getElementById('pfp2');
        if (avatarImg && avatarUrl) {
          avatarImg.src = avatarUrl;
          avatarImg.style.display = 'block';
        } else if (avatarImg) {
          avatarImg.style.display = 'none';
        }
      }
      
      displayBanner(state) {
        const bannerContainer = this.domUtils.getElementsByClassName('banner')[0];
        if (!bannerContainer) return;
        
        if (state.profileBannerUrl) {
          // Show character banner if available - add background image but preserve existing content
          bannerContainer.style.display = 'flex';
          bannerContainer.style.position = 'relative';
          
          // Create or update pseudo-element for blurred background
          const style = document.getElementById('banner-blur-style') || document.createElement('style');
          style.id = 'banner-blur-style';
          style.textContent = `
            .banner::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-image: url(${state.profileBannerUrl});
              background-size: cover;
              background-position: center;
              background-repeat: no-repeat;
              z-index: 10;
            }
          `;
          if (!document.getElementById('banner-blur-style')) {
            document.head.appendChild(style);
          }
        } else {
          // Remove banner background if no image
          const style = document.getElementById('banner-blur-style');
          if (style) {
            style.remove();
          }
        }
      }
      
      displayMasteries(state, masteries) {
        const container = this.domUtils.getElementById('masterydisplay');
        let html = '';
        
        // Display up to 6 masteries
        state.chosenMasteries.forEach((masteryId, index) => {
          const mastery = masteries.find(m => m.lookup === masteryId);
          const rank = state.chosenMasteriesRanks[index] || 0;
          
          if (mastery) {
            html += `
              <div class="mastery-rank-display">
                <span class="mastery-with-icon">
                  <img src="${mastery.image}" class="mastery-icon"> ${mastery.alt || mastery.name}
                </span>&nbsp;
                <span class="rank-badge ${this.getRankColorClass(this.getRankLabel(rank))}"> ${this.getRankLabel(rank)}</span>
              </div>
            `;
          }
        });
        
        this.domUtils.setHTML(container, html);
      }
      
      displayExpertise(state, expertise) {
        const container = this.domUtils.getElementById('expertisedisplay');
        let html = '';
        
        // Display expertise with same layout as masteries
        state.chosenExpertise.forEach((expertiseId, index) => {
          const expertiseData = expertise.find(e => e.lookup === expertiseId);
          const rank = state.chosenExpertiseRanks[index] || 0;
          
          if (expertiseData) {
            html += `
              <div class="expertise-rank-display">
                <span class="mastery-with-icon">
                  <img src="${expertiseData.image}" class="mastery-icon"> ${expertiseData.alt || expertiseData.name}
                </span>&nbsp;<span class="rank-badge ${this.getRankColorClass(this.getRankLabel(rank))}">${this.getRankLabel(rank)}</span>
              </div>
            `;
          }
        });
        
        this.domUtils.setHTML(container, html);
      }
      
      displayStats(stats) {
        // HP
        this.domUtils.setHTML(
          this.domUtils.querySelector('.hpdisplay'),
          `<div class="stats-display"><span class="mastery-with-icon"><img src="https://terrarp.com/db/tool/health.png" class="mastery-icon"> Health</span><span class="rank-badge stat-value">${stats.hp}</span></div>`
        );
        
        // Movement
        this.domUtils.setHTML(
          this.domUtils.querySelector('.movementdisplay'),
          `<div class="stats-display"><span class="mastery-with-icon"><img src="https://terrarp.com/db/tool/movement.png" class="mastery-icon"> Movement</span><span class="rank-badge stat-value">${stats.movement}</span></div>`
        );
        
        // Range (if > 0)
        if (stats.range > 0) {
          this.domUtils.setHTML(
            this.domUtils.querySelector('.rangedisplay'),
            `<div class="stats-display"><span class="mastery-with-icon"><img src="https://terrarp.com/db/tool/range.png" class="mastery-icon"> Range</span><span class="rank-badge stat-value">${stats.range}</span></div>`
          );
          this.domUtils.show(this.domUtils.querySelector('.rangedisplay'));
        } else {
          this.domUtils.hide(this.domUtils.querySelector('.rangedisplay'));
        }
        
        // Saves - display like equipment
        this.displaySaves(stats.saves);
        
        // V2 has no expertise bonuses to display
        
        // Calculate and display total score
        this.calculateAndDisplayTotalScore();
      }
      
      displaySaves(saves) {
        // Display saves like equipment items
        this.domUtils.setHTML(
          this.domUtils.querySelector('.fortitudesavedisplay'),
          `<div class="saves-rank-display"><span class="mastery-with-icon"><img src="https://terrarp.com/db/tool/fortitude.png" class="mastery-icon"> Fortitude</span><span class="rank-badge save-bonus">${saves.fortitude}</span></div>`
        );

        this.domUtils.setHTML(
          this.domUtils.querySelector('.reflexsavedisplay'),
          `<div class="saves-rank-display"><span class="mastery-with-icon"><img src="https://terrarp.com/db/tool/reflex.png" class="mastery-icon"> Reflex</span><span class="rank-badge save-bonus">${saves.reflex}</span></div>`
        );

        this.domUtils.setHTML(
          this.domUtils.querySelector('.willsavedisplay'),
          `<div class="saves-rank-display"><span class="mastery-with-icon"><img src="https://terrarp.com/db/tool/will.png" class="mastery-icon"> Will</span><span class="rank-badge save-bonus">${saves.will}</span></div>`
        );
      }
      
      calculateAndDisplayTotalScore() {
        const currentState = this.state.getState();
        
        // Use actual game bonuses from calculations system
        const getRankValue = (rank) => {
          let numericRank;
          if (typeof rank === 'string') {
            const rankMap = { 'E': 0, 'D': 1, 'C': 2, 'B': 3, 'A': 4, 'S': 5 };
            numericRank = rankMap[rank] || 0;
          } else {
            numericRank = Math.max(0, Math.min(5, rank)); // Ensure rank is between 0-5
          }
          
          // Use the actual game bonuses from calculations.js
          const RANK_BONUSES = {
            0: 0,   // E rank
            1: 10,  // D rank 
            2: 15,  // C rank
            3: 25,  // B rank
            4: 30,  // A rank
            5: 40   // S rank
          };
          
          return RANK_BONUSES[numericRank] || 0;
        };
        
        let totalScore = 0;
        let breakdown = [];
        
        // Equipment scores
        const weaponScore = getRankValue(currentState.weaponRank);
        const armorScore = getRankValue(currentState.armorRank);
        const accessoryScore = getRankValue(currentState.accessoryRank);
        
        totalScore += weaponScore + armorScore + accessoryScore;
        breakdown.push(`Weapon: ${this.getRankLabel(currentState.weaponRank)} (${weaponScore})`);
        breakdown.push(`Armor: ${this.getRankLabel(currentState.armorRank)} (${armorScore})`);
        breakdown.push(`Accessory: ${this.getRankLabel(currentState.accessoryRank)} (${accessoryScore})`);
        
        // Mastery scores - check multiple possible field names
        let masteryTotal = 0;
        const masteryRanks = currentState.masteryRanks || currentState.chosenMasteriesRanks || {};
        const masteryNames = currentState.masteryNames || currentState.chosenMasteries || [];
        
        // Handle different data structures
        if (Array.isArray(masteryRanks) && Array.isArray(masteryNames)) {
          // Arrays - match by index
          masteryNames.forEach((masteryName, index) => {
            const rank = masteryRanks[index];
            if (rank !== undefined) {
              const rankValue = getRankValue(rank);
              masteryTotal += rankValue;
              breakdown.push(`${masteryName}: ${this.getRankLabel(rank)} (${rankValue})`);
            }
          });
        } else if (typeof masteryRanks === 'object') {
          // Object - use as key-value pairs
          Object.entries(masteryRanks).forEach(([masteryId, rank]) => {
            const rankValue = getRankValue(rank);
            masteryTotal += rankValue;
            breakdown.push(`${masteryId}: ${this.getRankLabel(rank)} (${rankValue})`);
          });
        }
        
        totalScore += masteryTotal;
        
        // Expertise scores (V2 feature)
        let expertiseTotal = 0;
        const expertiseRanks = currentState.expertiseRanks || currentState.chosenExpertiseRanks || {};
        const expertiseNames = currentState.expertiseNames || currentState.chosenExpertise || [];
        
        // Handle different data structures for expertise (expertise worth 1/4 of masteries)
        if (Array.isArray(expertiseRanks) && Array.isArray(expertiseNames)) {
          // Arrays - match by index
          expertiseNames.forEach((expertiseName, index) => {
            const rank = expertiseRanks[index];
            if (rank !== undefined) {
              const fullRankValue = getRankValue(rank);
              const expertiseValue = Math.round(fullRankValue / 4); // Expertise worth 1/4
              expertiseTotal += expertiseValue;
              breakdown.push(`${expertiseName}: ${this.getRankLabel(rank)} (${expertiseValue})`);
            }
          });
        } else if (typeof expertiseRanks === 'object') {
          // Object - use as key-value pairs
          Object.entries(expertiseRanks).forEach(([expertiseId, rank]) => {
            const fullRankValue = getRankValue(rank);
            const expertiseValue = Math.round(fullRankValue / 4); // Expertise worth 1/4
            expertiseTotal += expertiseValue;
            breakdown.push(`${expertiseId}: ${this.getRankLabel(rank)} (${expertiseValue})`);
          });
        }
        
        totalScore += expertiseTotal;
        
        // Console log the scoring breakdown
        console.group('ðŸŽ¯ Build Scoring System');
        console.log(`Total Score: ${totalScore}`);
        console.log('');
        console.log('Equipment Breakdown:');
        console.log(`  Weapon: ${this.getRankLabel(currentState.weaponRank)} (${weaponScore} points)`);
        console.log(`  Armor: ${this.getRankLabel(currentState.armorRank)} (${armorScore} points)`);
        console.log(`  Accessory: ${this.getRankLabel(currentState.accessoryRank)} (${accessoryScore} points)`);
        console.log(`  Equipment Subtotal: ${weaponScore + armorScore + accessoryScore}`);
        console.log('');
        
        if (Object.keys(masteryRanks).length > 0) {
          console.log('Mastery Breakdown:');
          Object.entries(masteryRanks).forEach(([masteryId, rank]) => {
            const rankValue = getRankValue(rank);
            console.log(`  ${masteryId}: ${this.getRankLabel(rank)} (${rankValue} points)`);
          });
          console.log(`  Mastery Subtotal: ${masteryTotal}`);
          console.log('');
        }
        
        if (Object.keys(expertiseRanks).length > 0) {
          console.log('Expertise Breakdown:');
          Object.entries(expertiseRanks).forEach(([expertiseId, rank]) => {
            const rankValue = getRankValue(rank);
            console.log(`  ${expertiseId}: ${this.getRankLabel(rank)} (${rankValue} points)`);
          });
          console.log(`  Expertise Subtotal: ${expertiseTotal}`);
          console.log('');
        }
        
        // Calculate build rank based on total score (0-339 scale with SAABBB limits)
        const getBuildRank = (score) => {
          const ranks = [
            { grade: 'E', min: 0, max: 30 },
            { grade: 'E+', min: 31, max: 61 },
            { grade: 'D', min: 62, max: 92 },
            { grade: 'D+', min: 93, max: 123 },
            { grade: 'C', min: 124, max: 154 },
            { grade: 'C+', min: 155, max: 185 },
            { grade: 'B', min: 186, max: 216 },
            { grade: 'B+', min: 217, max: 247 },
            { grade: 'A', min: 248, max: 278 },
            { grade: 'A+', min: 279, max: 309 },
            { grade: 'S', min: 310, max: 338 },
            { grade: 'S+', min: 339, max: 339 }
          ];
          
          const rank = ranks.find(r => score >= r.min && score <= r.max);
          return rank ? rank.grade : 'E';
        };
        
        const buildRank = getBuildRank(totalScore);
        
        // Update the avatar rank badge
        this.updateRankBadge(buildRank);
        
        console.log(`ðŸ† TOTAL BUILD SCORE: ${totalScore} points`);
        console.log(`ðŸ“Š BUILD RANK: ${buildRank}`);
        console.log('');
        console.log('Rank Scale: E (0-30), E+ (31-61), D (62-92), D+ (93-123), C (124-154), C+ (155-185)');
        console.log('           B (186-216), B+ (217-247), A (248-278), A+ (279-309), S (310-338), S+ (339)');
        console.log('');
        console.log('Scoring: E=0, D=10, C=15, B=25, A=30, S=40 points per rank');
        console.log('         Expertise worth 1/4 value (E=0, D=2.5, C=3.75, B=6.25, A=7.5, S=10)');
        console.groupEnd();
        
        return { totalScore, buildRank };
      }
      
      updateDowncastIndicators(cardElement, clickedMasteryId, clickedMastery) {
        // Get the action ID from the card
        const actionId = cardElement.id.replace('final', '');
        const actions = this.dataLoader.cache.actions;
        const action = actions.find(a => a.lookup === actionId);
        
        if (!action) return;
        
        // Check if the clicked mastery would cause downcast for this action
        const isDowncast = this.isActionDowncast(action, clickedMastery);
        
        // Find or create the action downcast indicator
        let indicator = cardElement.querySelector('.action-downcast-indicator');
        
        if (isDowncast) {
          // Get the current state to find the mastery rank
          const currentState = this.state.getState();
          const masteryIndex = currentState.chosenMasteries.indexOf(clickedMasteryId);
          
          if (masteryIndex !== -1) {
            const currentRank = currentState.chosenMasteriesRanks[masteryIndex];
            const downcastRank = Math.max(0, currentRank - 1); // Downcast by 1 rank
            const rankLabels = ['E', 'D', 'C', 'B', 'A', 'S'];
            const currentRankLabel = rankLabels[currentRank];
            const downcastRankLabel = rankLabels[downcastRank];
            
            // Show indicator if it doesn't exist
            if (!indicator) {
              indicator = document.createElement('div');
              indicator.className = 'action-downcast-indicator';
              indicator.textContent = 'â¬‡';
              cardElement.appendChild(indicator);
            }
            
            // Update tooltip with rank downgrade info
            indicator.title = `A secondary role mastery has been detected, action rank will be reduced from MR X ${currentRankLabel} to MR${downcastRankLabel}.`;
            
            // Update the MR display in the rollcode to show downcast rank
            const masteryReplace = cardElement.querySelector('.masteryreplace');
            if (masteryReplace) {
              masteryReplace.innerHTML = downcastRankLabel;
            }
          }
          
          // Add downcast class to card
          cardElement.classList.add('downcast-action');
        } else {
          // Remove indicator if it exists
          if (indicator) {
            indicator.remove();
          }
          // Remove downcast class from card
          cardElement.classList.remove('downcast-action');
          
          // Reset MR to normal rank if not downcast
          const currentState = this.state.getState();
          const masteryIndex = currentState.chosenMasteries.indexOf(clickedMasteryId);
          
          if (masteryIndex !== -1) {
            const currentRank = currentState.chosenMasteriesRanks[masteryIndex];
            const rankLabels = ['E', 'D', 'C', 'B', 'A', 'S'];
            const currentRankLabel = rankLabels[currentRank];
            
            // Update the MR display to show normal rank
            const masteryReplace = cardElement.querySelector('.masteryreplace');
            if (masteryReplace) {
              masteryReplace.innerHTML = currentRankLabel;
            }
          }
        }
      }
      
      updateRankBadge(buildRank) {
        const badge = this.domUtils.getElementById('rank-badge-avatar');
        if (!badge) return;
        
        // Update badge text with superscript for + signs
        let displayText = buildRank;
        if (buildRank.includes('+')) {
          const baseLetter = buildRank.charAt(0);
          displayText = `${baseLetter}<sup>+</sup>`;
        }
        badge.innerHTML = displayText;
        
        // Remove all rank classes
        badge.className = 'rank-badge-avatar';
        
        // Add appropriate rank class
        let rankClass = buildRank.toLowerCase();
        if (rankClass === 's+') {
          rankClass = 'splus';
        } else {
          rankClass = rankClass.replace('+', '');
        }
        badge.classList.add(`rank-${rankClass}`);
      }
      
      displayEquipment(state) {
        const { armorType, weaponRank, armorRank, accessoryType = null, accessoryRank = 0 } = state;

        this.domUtils.setHTML(
          this.domUtils.querySelector('.weaponrankdisplay'),
          `<div class="equipment-rank-display"><span class="mastery-with-icon"><img src="https://terrarp.com/db/tool/weapon-rank.png" class="mastery-icon"> Weapon</span><span class="rank-badge ${this.getRankColorClass(this.getRankLabel(weaponRank))}">${this.getRankLabel(weaponRank)}</span></div>`
        );

        if (armorType && this.armorImages[armorType]) {
          this.domUtils.setHTML(
            this.domUtils.querySelector('.armorrankdisplay'),
            `<div class="equipment-rank-display"><span class="mastery-with-icon"><img src="${this.armorImages[armorType]}" class="mastery-icon"> ${armorType.charAt(0).toUpperCase() + armorType.slice(1)}</span><span class="rank-badge ${this.getRankColorClass(this.getRankLabel(armorRank))}">${this.getRankLabel(armorRank)}</span></div>`
          );
          
          // Set armor ability
          const armorAbilityData = this.getArmorAbility(armorType, armorRank);
          this.displayArmorAbility(armorAbilityData, armorType, armorRank);
        }

        if (accessoryType && this.accessoryImages[accessoryType]) {
          this.domUtils.setHTML(
            this.domUtils.querySelector('.accessoryrankdisplay'),
            `<div class="equipment-rank-display"><span class="mastery-with-icon"><img src="${this.accessoryImages[accessoryType]}" class="mastery-icon"> ${accessoryType.charAt(0).toUpperCase() + accessoryType.slice(1)}</span><span class="rank-badge ${this.getRankColorClass(this.getRankLabel(accessoryRank))}">${this.getRankLabel(accessoryRank)}</span></div>`
          );
        }
        
        // Populate mastery check icons
        this.populateMasteryCheckIcons(state);
        
        // Populate expertise check icons
        this.populateExpertiseCheckIcons(state);
      }
      
      getArmorAbility(armorType, armorRank) {
        // Use V2 armor abilities data
        const armorAbilities = window.armorAbilitiesV2;
        
        if (!armorAbilities) return { name: 'No ability', description: '', rollCode: '' };
        
        const rankLetter = this.getRankLabel(armorRank);
        const result = armorAbilities[armorType]?.[rankLetter] || { name: 'No ability', description: '', rollCode: '' };
        return result;
      }

      displayArmorAbility(abilityData, armorType, armorRank) {
        // Hide the old armor passive display area
        const armorSkillDisplay = this.domUtils.getElementById('equipmentpassive');
        if (armorSkillDisplay) {
          armorSkillDisplay.style.display = 'none';
        }

        // Find the Free actions container
        const freeActionsContainer = this.domUtils.getElementById('freeactiondisplay');
        if (!freeActionsContainer) return;

        // Remove any existing armor ability card
        const existingArmorCard = this.domUtils.querySelector('#armor-ability-card');
        if (existingArmorCard) {
          existingArmorCard.remove();
        }

        // Only add armor ability card if there's a valid ability
        if (!abilityData.name || abilityData.name === 'No ability' || armorRank === 0) {
          return;
        }

        const armorTypeName = armorType.charAt(0).toUpperCase() + armorType.slice(1);
        
        // Create armor ability card HTML
        const armorCard = `
          <div class="card normal" id="armor-ability-card">
            <div class="cardicon" style="background-color: #1e2131; background-image: url('${this.armorImages[armorType]}'); background-repeat: no-repeat; background-position: center; background-size: contain;"></div>
            <div class="cardtitle">${abilityData.name}</div>
            <div class="cardinfo">
              <p><em><b>${armorTypeName} Armor Ability</b></em></p>
              <p>${abilityData.description}</p>
            </div>
            <div class="rollcode">${abilityData.rollCode}</div>
          </div>
        `;

        // Insert the armor card right after the opening div of freeactiondisplay (before Attack card)
        const firstCard = freeActionsContainer.querySelector('.card');
        if (firstCard) {
          firstCard.insertAdjacentHTML('beforebegin', armorCard);
        } else {
          freeActionsContainer.insertAdjacentHTML('afterbegin', armorCard);
        }
      }
      
      populateMasteryCheckIcons(state) {
        const container = this.domUtils.getElementById('masterycheckicons');
        const masteries = this.dataLoader.cache.masteries;
        let html = '';
        
        state.chosenMasteries.forEach(masteryId => {
          const mastery = masteries.find(m => m.lookup === masteryId);
          if (mastery) {
            html += `<div class='display masterycircle ${mastery.lookup}' onclick='clickMastery(this)'><img src='${mastery.image}'></div>`;
          }
        });
        
        this.domUtils.setHTML(container, html);
      }
      
      populateExpertiseCheckIcons(state) {
        const container = this.domUtils.getElementById('expertiseicons');
        const expertise = this.dataLoader.cache.expertise;
        let html = '';
        
        state.chosenExpertise.forEach(expertiseId => {
          const expertiseData = expertise.find(e => e.lookup === expertiseId);
          if (expertiseData) {
            html += `<div class='display masterycircle ${expertiseData.lookup}' onclick='clickExpertise(this, "${expertiseId}")'><img src='${expertiseData.image}'></div>`;
          }
        });
        
        this.domUtils.setHTML(container, html);
      }
      
      displayActions(state, actions) {
        const container = this.domUtils.getElementById('actionsdisplay');
        const masteries = this.dataLoader.cache.masteries;
        let html = '';
        
        // Add base actions first (attack, rush - no recover in V2)
        this.displayBaseActions(state, masteries);
        
        // Add chosen actions
        state.chosenActions.forEach(actionId => {
          const action = actions.find(a => a.lookup === actionId);
          if (action && !['attack', 'rush'].includes(action.lookup)) {
            html += this.generateActionCard(action, state, masteries);
          }
        });
        
        this.domUtils.setHTML(container, html);
      }
      
      displayBaseActions(state, masteries) {
        const baseActions = ['attack', 'rush'];
        const actions = this.dataLoader.cache.actions;
        
        baseActions.forEach(actionId => {
          const action = actions.find(a => a.lookup === actionId);
          if (action) {
            const container = this.domUtils.querySelector(`.card.${actionId}final`);
            if (container) {
              // Remove any existing downcast indicators and classes - they only show when mastery is clicked
              const existingIndicator = container.querySelector('.action-downcast-indicator');
              if (existingIndicator) {
                existingIndicator.remove();
              }
              container.classList.remove('downcast-action');
              
              this.domUtils.setHTML(container, this.generateActionCardContent(action, state, masteries));
            }
          }
        });
      }
      
      generateActionCard(action, state, masteries) {
        // Don't show downcast indicators by default - they only appear when mastery is clicked
        return `<div class="card" id="${action.lookup}final" style="border-color: ${action.color}">
          ${this.generateActionCardContent(action, state, masteries)}
        </div>`;
      }
      
      generateActionCardContent(action, state, masteries) {
        const rollSection = action.dice && action.dice !== '-' ? 
          `<div class="cardroll"><b>Roll:</b> ${action.dice}</div>` : '';
        
        const rollCodeSection = action.roll && action.roll !== '-' ? 
          `<div class="rollcode">${action.roll}</div>` : '';
        
        // Generate mastery icons for this action
        const masteryIcons = this.generateMasteryIcons(action, state, masteries);
        
        return `
          <div class="cardicon" style="background-color: ${action.color}; background-image: url('${action.image}'); background-repeat: no-repeat; background-position: center;"></div>
          <div class="cardtitle">${action.name}</div>
          <div class="cardinfo">${action.description}</div>
          ${rollSection}
          ${rollCodeSection}
          ${masteryIcons}
        `;
      }
      
      isActionDowncast(action, mastery) {
        // Check if the mastery's primary role matches the action's category
        // If not, it's downcast (mastery is being used outside its primary role)
        return mastery.primaryRole !== action.category;
      }
      
      hasDowncastMasteries(action, state, masteries) {
        if (!action.masteries) return false;
        
        const applicableMasteries = state.chosenMasteries.filter(masteryId => 
          action.masteries.includes(masteryId)
        );
        
        return applicableMasteries.some(masteryId => {
          const mastery = masteries.find(m => m.lookup === masteryId);
          return mastery && this.isActionDowncast(action, mastery);
        });
      }
      
      generateMasteryIcons(action, state, masteries) {
        if (!action.masteries) return '';
        
        const applicableMasteries = state.chosenMasteries.filter(masteryId => 
          action.masteries.includes(masteryId)
        );
        
        if (applicableMasteries.length === 0) return '';
        
        let html = '<div class="masteryicon">';
        applicableMasteries.forEach(masteryId => {
          const mastery = masteries.find(m => m.lookup === masteryId);
          if (mastery) {
            const isDowncast = this.isActionDowncast(action, mastery);
            const downcastClass = isDowncast ? ' downcast' : '';
            const downcastIndicator = isDowncast ? '<div class="downcast-indicator">â†“</div>' : '';
            
            html += `<div class="display masterycircle ${masteryId}${downcastClass}" data-mastery="${masteryId}" data-action="${action.lookup}" onclick="clickMastery(this)">
              <img class="${masteryId}" src="${mastery.image}">
              ${downcastIndicator}
            </div>`;
          }
        });
        html += '</div>';
        
        return html;
      }
      
      generateBuildCodes(state) {
        // Generate compact build URL
        const buildURL = this.buildEncoder.generateCompactBuildCode(state);
        this.domUtils.setValue(this.domUtils.getElementById('build-url'), buildURL);
      }
      
      replaceCharacterName(characterName) {
        if (!characterName) return;
        
        // Replace in all sections that contain roll codes
        const sectionsToUpdate = [
          'freeactiondisplay',
          'actionsdisplay', 
          'saveschecks'
        ];
        
        sectionsToUpdate.forEach(sectionId => {
          const section = this.domUtils.getElementById(sectionId);
          if (section) {
            section.innerHTML = section.innerHTML.replace(/Character Name/g, characterName);
          }
        });
        
        // Replace in armor passive if it exists
        const armorPassive = this.domUtils.querySelector('.charpassive');
        if (armorPassive) {
          armorPassive.innerHTML = armorPassive.innerHTML.replace(/Character Name/g, characterName);
        }
        
        // Update character name display
        const charNameElement = this.domUtils.querySelector('.charname');
        if (charNameElement) {
          charNameElement.innerHTML = characterName;
        }
      }
      
      replaceWeaponRank(weaponRank) {
        if (weaponRank === undefined || weaponRank === null) return;
        
        // Convert weapon rank number to letter
        const rankLetters = ['E', 'D', 'C', 'B', 'A', 'S'];
        const weaponRankLetter = rankLetters[weaponRank] || 'E';
        
        // Replace in all sections that contain roll codes
        const sectionsToUpdate = [
          'freeactiondisplay',
          'actionsdisplay', 
          'saveschecks'
        ];
        
        sectionsToUpdate.forEach(sectionId => {
          const section = this.domUtils.getElementById(sectionId);
          if (section) {
            section.innerHTML = section.innerHTML.replace(/WR/g, weaponRankLetter);
          }
        });
        
        // Replace in armor passive if it exists
        const armorPassive = this.domUtils.querySelector('.charpassive');
        if (armorPassive) {
          armorPassive.innerHTML = armorPassive.innerHTML.replace(/WR/g, weaponRankLetter);
        }
      }
      
      setupThreadCode() {
        const threadCodeInput = this.domUtils.getElementById('threadcodereplace');
        
        if (threadCodeInput) {
          // Update in real-time as user types
          this.domUtils.addEventListener(threadCodeInput, 'input', () => this.updateThreadCode());
          
          // Also update on enter key
          this.domUtils.addEventListener(threadCodeInput, 'keypress', (e) => {
            if (e.key === 'Enter') {
              this.updateThreadCode();
            }
          });
        }
      }
      
      restoreThreadCode() {
        const currentState = this.state.getState();
        const savedThreadCode = currentState.threadCode;
        
        if (savedThreadCode) {
          // Restore the input value
          const threadCodeInput = this.domUtils.getElementById('threadcodereplace');
          if (threadCodeInput) {
            this.domUtils.setValue(threadCodeInput, savedThreadCode);
          }
          
          // Update all thread code displays
          this.updateThreadCode();
        }
      }
      
      updateThreadCode() {
        const newCode = this.domUtils.getValue(this.domUtils.getElementById('threadcodereplace'));
        const elements = this.domUtils.querySelectorAll('.thrcode');
        
        // Update all thread code elements
        elements.forEach(element => {
          this.domUtils.setText(element, newCode || 'Thread Code');
        });
        
        // Save thread code to state for persistence
        this.state.updateState({ threadCode: newCode });
        
        // Regenerate build codes with new thread code
        const currentState = this.state.getState();
        this.generateBuildCodes(currentState);
      }
      
      updateNote() {
        const noteTextarea = this.domUtils.getElementById('note');
        if (!noteTextarea) return;
        
        const newNote = noteTextarea.value;
        
        // Save note to state for persistence
        this.state.updateState({ note: newNote });
        
        // Regenerate build codes with new note
        const currentState = this.state.getState();
        this.generateBuildCodes(currentState);
      }

      
      setupEventListeners() {
        // Copy buttons
        this.domUtils.querySelectorAll('.copy-button').forEach(button => {
          this.domUtils.addEventListener(button, 'click', (e) => {
            const targetId = e.target.dataset.target;
            const textarea = this.domUtils.getElementById(targetId);
            if (textarea) {
              textarea.select();
              document.execCommand('copy');
              e.target.textContent = 'Copied!';
              setTimeout(() => {
                e.target.textContent = 'Copy';
              }, 2000);
            }
          });
        });
        
        // Navigation buttons
        this.domUtils.addEventListener(
          this.domUtils.getElementById('back-button'),
          'click',
          () => this.goToPreviousPage()
        );

        
        this.domUtils.addEventListener(
          this.domUtils.getElementById('edit-build-button'),
          'click',
          () => this.editBuild()
        );
        
        // Note textarea - save on input and update build URL
        const noteTextarea = this.domUtils.getElementById('note');
        if (noteTextarea) {
          this.domUtils.addEventListener(noteTextarea, 'input', () => this.updateNote());
        }

      }
      
      goToPreviousPage() {
        const url = this.state.generateURL('action-selector.html');
        window.location.href = url;
      }
      
      editBuild() {
        const currentState = this.state.getState();
        
        // If character was imported from Terrarp, skip to action selection
        // since masteries and ranks are already set from the API
        if (currentState.profileBannerUrl) {
          const url = this.state.generateURL('action-selector.html');
          window.location.href = url;
        } else {
          // For manual builds, go back to mastery selection
          const url = this.state.generateURL('mastery-selector.html');
          window.location.href = url;
        }
      }
      
      loadFromBuildCode() {
        const hash = window.location.hash;
        if (hash && (hash.includes('#load.') || hash.includes('#import.') || hash.includes('#sample.') || hash.includes('#compact.'))) {
          try {
            const result = this.buildEncoder.loadFromURL();
            if (result.success) {
              this.state.updateState(result.data);
            } else {
              console.warn('BuildSheet V2: Failed to load build from URL:', result.error);
            }
          } catch (error) {
            console.error('BuildSheet V2: Error loading build code:', error);
          }
        }
      }
      
      adjustNavigationForImportedCharacter() {
        const currentState = this.state.getState();
        
        // If character has profileBannerUrl, it was imported from Terrarp
        if (currentState.profileBannerUrl) {
          // Hide "< Select Actions" button
          const backButton = this.domUtils.getElementById('back-button');
          if (backButton) {
            backButton.style.display = 'none';
          }
        } else {
          // For manual builds (no banner), add top padding to prevent cut-off appearance
          const builddisplay = this.domUtils.getElementById('builddisplay');
          if (builddisplay) {
            // builddisplay.style.paddingTop = '60px';
          }
        }
      }
      
      showError(message) {
        const container = this.domUtils.getElementById('builddisplay');
        this.domUtils.showError(container, message);
      }
    }
    
    // Global reference to BuildSheet instance
    let buildSheetInstance = null;
    
    // Global click functions for roll code interaction
    function clickMastery(element) {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      
      // Find the mastery ID from the element's class
      const classList = element.classList.toString();
      
      // The classList might contain multiple classes, need to find the mastery one
      const classArray = classList.split(' ');
      let masteryId = null;
      let masteryIndex = -1;
      
      // Find which class corresponds to a chosen mastery
      for (const className of classArray) {
        masteryIndex = state.chosenMasteries.indexOf(className);
        if (masteryIndex !== -1) {
          masteryId = className;
          break;
        }
      }
      
      
      if (masteryIndex !== -1) {
        // Get rank letter
        const rankLetters = ['E', 'D', 'C', 'B', 'A', 'S'];
        const rankLetter = rankLetters[state.chosenMasteriesRanks[masteryIndex]];
        
        // Find mastery name
        const mastery = masteries.find(m => m.lookup === masteryId);
        const masteryName = mastery ? mastery.name : 'Mastery';
        
        
        // Find the roll code container and update
        const cardElement = element.closest('.card');
        if (cardElement) {
          const rollCodeElement = cardElement.querySelector('.rollcode');
          const masteryReplace = cardElement.querySelector('.masteryreplace');
          const mnameReplace = cardElement.querySelector('.mnamereplace');
          
          
          // Update the spans FIRST, then update the command
          if (masteryReplace) {
            masteryReplace.innerHTML = rankLetter;
          }
          if (mnameReplace) {
            mnameReplace.innerHTML = masteryName;
          }
          
          // Update downcast indicators based on clicked mastery
          buildSheetInstance.updateDowncastIndicators(cardElement, masteryId, mastery);
        }
      }
    }
    
    function clickFortitude() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const expertise = buildSheetInstance.dataLoader.cache.expertise;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, [], expertise);
      
      document.querySelector('.savereplace').innerHTML = 'Fortitude';
      document.querySelector('.savebonusreplace').innerHTML = stats.saves.fortitude;
      document.querySelector('.reflexmodifiers').innerHTML = '';
    }
    
    function clickReflex() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const expertise = buildSheetInstance.dataLoader.cache.expertise;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, [], expertise);
      
      document.querySelector('.savereplace').innerHTML = 'Reflex';
      document.querySelector('.savebonusreplace').innerHTML = stats.saves.reflex;
      document.querySelector('.reflexmodifiers').innerHTML = stats.saves.reflexmod || '';
    }
    
    function clickWill() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const expertise = buildSheetInstance.dataLoader.cache.expertise;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, [], expertise);
      
      document.querySelector('.savereplace').innerHTML = 'Will';
      document.querySelector('.savebonusreplace').innerHTML = stats.saves.will;
      document.querySelector('.reflexmodifiers').innerHTML = '';
    }
    
    function clickExpertise(element, expertiseId) {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const expertiseList = buildSheetInstance.dataLoader.cache.expertise;
      
      // Find the expertise data and rank
      const expertiseIndex = state.chosenExpertise.indexOf(expertiseId);
      if (expertiseIndex !== -1) {
        const expertiseData = expertiseList.find(e => e.lookup === expertiseId);
        const rank = state.chosenExpertiseRanks[expertiseIndex];
        const rankLetters = ['E', 'D', 'C', 'B', 'A', 'S'];
        const rankLetter = rankLetters[rank];
        
        document.querySelector('.expertisereplace').innerHTML = expertiseData ? expertiseData.name : 'Expertise';
        document.querySelector('.expertisebonusreplace').innerHTML = rankLetter;
      }
    }
    
    // Advantage/disadvantage toggle functions for saves
    function advantageSave() {
      document.querySelector('.saveadv').innerHTML = 'adv ';
    }
    
    function normalSave() {
      document.querySelector('.saveadv').innerHTML = '';
    }
    
    function disadvantageSave() {
      document.querySelector('.saveadv').innerHTML = 'dis ';
    }
    
    // Advantage/disadvantage toggle functions for expertise
    function advantageExpertise() {
      document.querySelector('.expertiseadv').innerHTML = 'adv ';
    }
    
    function normalExpertise() {
      document.querySelector('.expertiseadv').innerHTML = '';
    }
    
    function disadvantageExpertise() {
      document.querySelector('.expertiseadv').innerHTML = 'dis ';
    }
    
    // Advantage/disadvantage toggle functions for mastery
    function advantageMastery() {
      document.querySelector('.masteryadv').innerHTML = 'adv ';
    }
    
    function normalMastery() {
      document.querySelector('.masteryadv').innerHTML = '';
    }
    
    function disadvantageMastery() {
      document.querySelector('.masteryadv').innerHTML = 'dis ';
    }
    
    // Initialize when page loads
    window.onload = function() {
      buildSheetInstance = new BuildSheetV2();
    };
  </script>

  <style>
    .note {
      background-color: rgb(13, 15, 22);
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
    }

    .build-sharing {
      background-color: #23293775;
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
    }

    .share-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .share-option {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .share-option label {
      font-weight: bold;
      color: #FFF;
    }

    .share-option textarea {
      min-height: 60px;
      padding: 8px;
      border: 1px solid #ced4da;
      background-color: #232937;
      color: #FFF;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
    }


    .copy-button {
      align-self: flex-start;
      padding: 6px 12px;
      background-color: #a9357b;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .copy-button:hover {
      background-color: #a9357b;
    }

    .displaytitle {
      font-weight: bold;
      margin-bottom: 4px;
    }

    /* Grid containers for saves, masteries, expertise, equipment, and stats */
    #savesdisplay,
    #masterydisplay,
    #expertisedisplay,
    #equipmentdisplay,
    #statsdisplay {
      display: flex;
      gap: 0px;
      /*top: -90px;*/
      position: relative;
      background: linear-gradient(180deg, transparent, rgba(17,20,28,1) 100%);
    }

    @media (max-width: 575px) {
      #savesdisplay,
      #masterydisplay,
      #expertisedisplay,
      #equipmentdisplay {
        grid-template-columns: repeat(2, 1fr);
      }
      #statsdisplay {
        justify-content: center !important;
      }
    }


    @media (max-width: 768px) and (min-width: 576px) {
      #savesdisplay,
      #masterydisplay,
      #expertisedisplay,
      #equipmentdisplay{
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* New rank display styles matching dice-roller-frontend */
    .mastery-rank-display,
    .expertise-rank-display,
    .saves-rank-display,
    .equipment-rank-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background-color: rgb(13, 15, 22);
      color: white;
      border-radius: 6px;
      border: 1px solid rgba(147, 51, 234, 0.3);
      font-size: 12px;
    }

    .stats-display {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      color: white;
      font-size: 12px;
    }

    .expertise-rank-display {
      background-color: rgb(13, 15, 22);
      border: 1px solid rgba(38, 38, 220, 0.3);
    }

    .equipment-rank-display {
      background-color: rgb(13, 15, 22);
      border: 1px solid rgba(220, 38, 38, 0.3);
    }

    .saves-rank-display {
      background-color: rgb(13, 15, 22);
      border: 1px solid rgba(38, 220, 38, 0.3);
    }

    .rank-badge {
      font-weight: bold;
      font-size: 12px;
    }

    /* Rank color classes */
    .rank-s { color: #fbbf24 !important; } /* Yellow/Gold */
    .rank-a { color: #fb923c !important; } /* Orange */
    .rank-b { color: #f472b6 !important; } /* Pink */
    .rank-c { color: #4ade80 !important; } /* Green */
    .rank-d { color: #60a5fa !important; } /* Blue */
    .rank-e { color: #9ca3af !important; } /* Gray */

    /* Inline mastery icons */
    .mastery-with-icon {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mastery-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .statheader {
      /*top: -90px;*/
      position: relative;
      padding: 0 8px 4px 8px;
      color: #fff;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    @media (min-width: 900px){
      #bodyback  {
        width: 900px;
        margin-top: 120px;
      }
    }


    .selectorheader {
      margin-top: 10px;
    }

    /* Equipment and Saves side-by-side layout */
    .equipment-saves-container {
      display: flex;
      gap: 0px;
      margin-bottom: 16px;
    }

    .equipment-section,
    .saves-section {
      flex: 1;
    }

    .equipment-section #equipmentdisplay,
    .saves-section #savesdisplay {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    /* Mobile: stack vertically */
    @media (max-width: 768px) {
      .equipment-saves-container {
        flex-direction: column;
        gap: 0;
      }
    }

    /* Mastery and Expertise side-by-side layout */
    .mastery-expertise-container {
      display: flex;
      gap: 0px;
      margin-bottom: 16px;
    }

    .mastery-section,
    .expertise-section {
      flex: 1;
    }

    .mastery-section #masterydisplay,
    .expertise-section #expertisedisplay {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    @media (max-width: 475px) {
      #bodyback  {
        margin-top: 84px;
      }

      .characterstuff {
        padding-right: 0 !important;
      }

      .nameheader {
        text-align: left;
      }

      .charname {
        font-size: 18px !important;
      }

      .chartitle {
        font-size: 12px !important;
      }

      .banner {
        margin: 0 !important;
      }

      .header-info--functions {
        padding-right: 10px;
        width: 100px !important;
      }
    }

    @media (min-width: 476px) and (max-width: 576px) {
      #bodyback  {
        margin-top: 84px;
      }
    }

    @media (min-width: 576px) and (max-width: 899px) {
      #bodyback  {
        margin-top: 120px;
      }
    }

    @media (max-width: 650px) {
      .nameheader {
        width: 100%;
        text-align: left !important;
      }

      .mastery-section, .expertise-section {
        margin-bottom: 16px;
      }
    }


    /* Mobile: stack vertically */
    @media (max-width: 768px) {
      .mastery-expertise-container {
        flex-direction: column;
        gap: 0;
      }
      
      .mastery-section #masterydisplay,
      .expertise-section #expertisedisplay {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat-value {
        font-weight: bold;
        font-size: 18px !important;
      }
    }

    .stat-value {
      font-weight: bold;
      font-size: 24px;
    }

    .bannercontent {
      background: linear-gradient(0deg, transparent 0%, rgba(17,20,28,1) 100%);
      justify-content: center;
      /*align-items: center;*/
      width: 100%;
      padding: 0px 10px;
      display: flex;
      box-sizing: border-box;
      z-index: 500;
      height: 120px;
    }
    
    /* Downcasting styles */
    .downcast-action {
      /*animation: glow-downcast 2s ease-in-out infinite alternate;*/
    }
    
    .action-downcast-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255, 165, 0, 1);
      color: white;
      border-radius: 50%;
      border-color: rgb(13, 15, 22);
      border-width: 2px;
      border-style: solid;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      z-index: 10;
    }
    
    .masterycircle.downcast {
      opacity: 0.7;
      border-style: dashed !important;
      border-width: 2px !important;
    }
    
    .masterycircle .downcast-indicator {
      position: absolute;
      bottom: -3px;
      right: -3px;
      background: orange;
      color: white;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: bold;
      z-index: 5;
      pointer-events: none;
    }
    
    .masterycircle {
      position: relative;
    }
    
    .card {
      position: relative;
    }

    .characterstuff {
      padding-left: 10px;
      padding-right: 120px;
    }

    .charcontainer {
      padding-left: 0;
    }

    .charname {
      font-size: 2.5rem;
    }

    .chartitle {
      font-weight: normal;
      color: #fff;
    }

    .charrace {
      padding-top: 2px;
      font-weight: normal;
    }
    
    /* Rank badge styling */
    .avatar-container {
      position: relative;
      display: inline-block;
    }
    
    .rank-badge-avatar {
      position: absolute;
      top: 14px;
      right: -4px;
      background: linear-gradient(0deg, rgba(17,20,28,1) 0%, rgba(17,20,28,1) 100%) !important;
      color: white;
      border-width: 1px;
      border-style: solid;
      border-color: #fff;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      z-index: 10;
    }
    
    .rank-badge-avatar sup {
      font-size: 10px;
      vertical-align: super;
      line-height: 0;
    }
    
    /* Rank-specific colors matching mastery badges */
    .rank-badge-avatar.rank-e { color: #6b7280; border-color: #6b7280;} /* Gray */
    .rank-badge-avatar.rank-d { color: #3b82f6; border-color: #3b82f6;} /* Blue */
    .rank-badge-avatar.rank-c { color: #22c55e; border-color: #22c55e;} /* Green */
    .rank-badge-avatar.rank-b { color: #ec4899; border-color: #ec4899;} /* Pink */
    .rank-badge-avatar.rank-a { color: #f97316; border-color: #f97316;} /* Orange */
    .rank-badge-avatar.rank-s { color: #f59e0b; border-color: #f59e0b;} /* Gold/Yellow */
    .rank-badge-avatar.rank-splus { 
      color: #f59e0b;
      border-color: #f59e0b;
      /*animation: glow-ss 2s ease-in-out infinite alternate;*/
    }
    
    @keyframes glow-ss {
      from { box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 0 15px rgba(251, 191, 36, 0.4); }
      to { box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 0 25px rgba(251, 191, 36, 0.8); }
    }

    @keyframes glow-downcast {
      from { box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 0 15px rgba(255, 0, 0, 0.4); }
      to { box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 0 25px rgba(200, 0, 0, 0.8); }
    }
  </style>
</body>
</html>