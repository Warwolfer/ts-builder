<!DOCTYPE html>
<html>
<head>
  <title>TerraSphere Build Editor - Character Build</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="app.css">
  <link rel="stylesheet" href="index.css">
  <link rel="shortcut icon" href="https://www.terrarp.com//favicon.ico">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  
  <!-- Shared modules -->
  <script src="shared/state-manager.js"></script>
  <script src="shared/dom-utils.js"></script>
  <script src="shared/data-loader.js"></script>
  <script src="shared/calculations.js"></script>
  <script src="shared/build-encoder.js"></script>
  
  <!-- Data files -->
  <script src="masteries.js"></script>
  <script src="actions.js"></script>
  <script src="safecharacters.js"></script>
  <script src="armor-abilities.js"></script>
</head>

<body>
  <nav id="mw-navigation" class="fixed-top">
    <div class="container">
      <a href="https://terrarp.com/build/" class="navbar-brand">
        <img src="https://terrarp.com/db/logo/logo-xs.png">
      </a>
      <div class="nav-left">
        <div class="link"><a href="https://terrarp.com/build/index.html" style="color:#47cbdd">Build Planner</a></div>
        <div class="link"><a href="https://terrarp.com/index.php">Forums</a></div>
        <div class="link"><a href="https://terrarp.com/wiki/Main_Page">Wiki</a></div>
        <div class="dropdown">
          <button class="dropbtn">Important <i class="fa fa-caret-down"></i></button>
          <div class="dropdown-content">
            <a href="https://terrarp.com/wiki/Mastery">Mastery List</a>
            <a href="https://terrarp.com/wiki/Races">Playable Races</a>
            <a href="https://terrarp.com/wiki/RPG_Mechanics">RPG Mechanics</a>
            <a href="https://terrarp.com/wiki/Actions">Action List</a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="header-info">
    <div class="header-info--content">
      <div class="charimg2 left"><img id="pfp2"></div>
      <div class="charcontainer left">
        <h1 class="nameheader header-info--nameheader">
          <span class="charname" id="character-name-display">Character Build</span>
        </h1><br>
        <h2 class="charinfo">
          <span class="charrace" id="character-race-display"></span>
        </h2>
      </div>
      <div class="header-info--functions right">
        <div class="masterycategory" id="inputbox">
          <table class="typebox">
            <tr>
              <td id="threadcodeinput">
                <input type="text" id="threadcodereplace" autocomplete="off" placeholder="Thread code (510C5)...">
              </td>
              <td id="threadcodebutton">
                <div id="thrcodebutton" class="threadcodeinput">Update</div>
              </td>
            </tr>
          </table>
        </div>
        <div id="finalbuild"></div>
      </div>
    </div>
  </div>

  <div id="bodyback">
    <div id="builddisplay">
      <!-- Masteries Display -->
      <div class="banner"></div>
      <div class="masterycategory mastery-margin" id="masterydisplay"></div>

      <!-- Stats Display -->
      <div class="masterycategory first" id="statsdisplay">
        <div class="hpcontainer">
          <div class='hp'>
            <div class='stat-text'>Health</div>
            <img src='https://terrarp.com/db/tool/health.png'>
          </div>
        </div>
        <div class="movementcontainer">
          <div class='move'>
            <div class='stat-text'>Movement</div>
            <img src='https://terrarp.com/db/tool/movement.png'>
          </div>
        </div>
        <div class="rangecontainer">
          <div class='range'>
            <div class='stat-text'>Range</div>
            <img src='https://terrarp.com/db/tool/range.png'>
          </div>
        </div>
        <div class="savecontainer">
          <div><b>Saves</b></div>
          <div>
            <table class="stat-numbers">
              <tr>
                <td><i class="fas fa-heartbeat"></i></td>
                <td>Fortitude</td>
                <td id="fortitudesave">+0</td>
              </tr>
              <tr>
                <td><i class="fas fa-shoe-prints"></i></td>
                <td>Reflex</td>
                <td id="reflexsave">+0</td>
              </tr>
              <tr>
                <td><i class="fas fa-head-side-brain"></i></td>
                <td>Will</td>
                <td id="willsave">+0</td>
              </tr>
            </table>
          </div>
        </div>
        <div class="expertisecontainer">
          <b>Expertise</b>
          <div>
            <table class="stat-numbers">
              <tr>
                <td><i class="fas fa-walking"></i></td>
                <td>Fitness</td>
                <td id="skillfitness">+0</td>
              </tr>
              <tr>
                <td><i class="fas fa-hand-paper"></i></td>
                <td>Knack</td>
                <td id="skillknack">+0</td>
              </tr>
              <tr>
                <td><i class="fas fa-eye"></i></td>
                <td>Awareness</td>
                <td id="skillawareness">+0</td>
              </tr>
              <tr>
                <td><i class="fas fa-book"></i></td>
                <td>Knowledge</td>
                <td id="skillknowledge">+0</td>
              </tr>
              <tr>
                <td><i class="fas fa-users-crown"></i></td>
                <td>Presence</td>
                <td id="skillpresence">+0</td>
              </tr>
            </table>
          </div>
        </div>
      </div>

      <!-- Equipment Display -->
      <h3 class="selectorheader">Equipment</h3>
      <div class="masterycategory" id="equipmentdisplay">
        <div class="edisplay weaponrankdisplay">
          <div class='displaycircle equipment'>
            <img src='https://terrarp.com/db/tool/weapon-rank.png'>
          </div>
          <div class='displaytitle'>Weapon</div>
        </div>
        <div class="edisplay armorrankdisplay">
          <div class='displaycircle equipment'>
            <img id="armordisplay">
          </div>
          <div class='displaytitle'>
            <span id='aweight'></span>Armor
          </div>
        </div>
      </div>
      <div class="masterycategory" id="equipmentdisplay" style="margin-top:0">
        <div class="edisplay armorskilldisplay">
          <div class="passivecontainer">
            <span class='armorpassive'></span>
          </div>
        </div>
      </div>

      <!-- Saves and Checks -->
      <h3 class="selectorheader" id="savechecklabel">Saves and Checks
        <span class="ttip" data-tooltip="Click on the small icons at the bottom of the following cards to automatically apply the bonus and type name to the Discord roll code.">
          <span class="ttip-info"></span><i class="far fa-question-circle tip"></i>
        </span>
      </h3>
      <div class="masterycategory" id="saveschecks">
        <div class="card">
          <div class="cardtitle">Saves</div>
          <div class="rollcode">?r save <span class='saveadv'></span><span class='savebonusreplace'>X</span> <span class='reflexmodifiers'></span> # <span class='savereplace'>Type</span> | Character Name | <span class="thrcode">Thread Code</span></div>
          <div id="savesicons">
            <div class='display masterycircle aci-fortitude' onclick='clickFortitude(this)'>
              <img src='https://terrarp.com/db/tool/fortitude.png'>
            </div>
            <div class='display masterycircle aci-reflex' onclick='clickReflex(this)'>
              <img src='https://terrarp.com/db/tool/reflex.png'>
            </div>
            <div class='display masterycircle aci-will' onclick='clickWill(this)'>
              <img src='https://terrarp.com/db/tool/will.png'>
            </div>
          </div>
          <div class="togglecontainer">
            <div class="togglesavechecks" onclick="advantageSave()">Adv</div>
            <div class="togglesavechecks" onclick="normalSave()">Normal</div>
            <div class="togglesavechecks" onclick="disadvantageSave()">Dis</div>
          </div>
        </div>
        <div class="card">
          <div class="cardtitle">Expertise Check</div>
          <div class="rollcode">?r expertise <span class='expertiseadv'></span><span class='expertisebonusreplace'>X</span> # <span class='expertisereplace'>Type</span> | Character Name | <span class="thrcode">Thread Code</span></div>
          <div id="expertiseicons">
            <div class='display masterycircle aci-fitness' onclick='clickFitness(this)'>
              <img src='https://terrarp.com/db/tool/fitness.png'>
            </div>
            <div class='display masterycircle aci-knack' onclick='clickKnack(this)'>
              <img src='https://terrarp.com/db/tool/knack.png'>
            </div>
            <div class='display masterycircle aci-awareness' onclick='clickAwareness(this)'>
              <img src='https://terrarp.com/db/tool/awareness.png'>
            </div>
            <div class='display masterycircle aci-knowledge' onclick='clickKnowledge(this)'>
              <img src='https://terrarp.com/db/tool/knowledge.png'>
            </div>
            <div class='display masterycircle aci-presence' onclick='clickPresence(this)'>
              <img src='https://terrarp.com/db/tool/presence.png'>
            </div>
          </div>
          <div class="togglecontainer">
            <div class="togglesavechecks" onclick="advantageExpertise()">Adv</div>
            <div class="togglesavechecks" onclick="normalExpertise()">Normal</div>
            <div class="togglesavechecks" onclick="disadvantageExpertise()">Dis</div>
          </div>
        </div>
        <div class="card">
          <div class="cardtitle">Mastery Check</div>
          <div class="rollcode">?r mastery <span class='masteryadv'></span><span class='masteryreplace'>MR</span> # <span class='mnamereplace'>Type</span> | Character Name | <span class="thrcode">Thread Code</span></div>
          <div id="masterycheckicons"></div>
          <div class="togglecontainer">
            <div class="togglesavechecks" onclick="advantageMastery()">Adv</div>
            <div class="togglesavechecks" onclick="normalMastery()">Normal</div>
            <div class="togglesavechecks" onclick="disadvantageMastery()">Dis</div>
          </div>
        </div>
      </div>

      <!-- Actions Display -->
      <h3 class="selectorheader">Actions</h3>
      <div class="masterycategory" id="freeactiondisplay">
        <!-- Free actions -->
        <div class="card normal">
          <div class="cardicon aci-attack"></div>
          <div class="cardtitle">Attack</div>
          <div class="cardinfo">
            <p><em><b>Base</b><b>Offense</b><b>Attack</b></em></p>
            <p>Perform a basic attack.</p>
          </div>
          <div class="cardroll"><b>Roll:</b> 1d100 + MR + WR + other bonuses</div>
        </div>
        <div class="card recover">
          <div class="cardicon aci-recover"></div>
          <div class="cardtitle">Recover</div>
          <div class="cardinfo">
            <p><em><b>Base</b><b>Action</b></em></p>
            <p>Recover your HP by 1d20. Double your roll result on a nat-20.</p>
          </div>
          <div class="cardroll"><b>Roll:</b> 1d20</div>
        </div>
        <div class="card rushfinal">
          <div class="cardicon aci-rush"></div>
          <div class="cardtitle">Rush</div>
          <div class="cardinfo">
            <p><em><b>Base</b><b>Bonus</b></em></p>
            <p><b>Bonus.</b> Double your total movement count this cycle.</p>
          </div>
          <div class="rollcode rushrc">?r barush # Character Name | <span class="thrcode">Code</span></div>
        </div>
      </div>
      <div class="masterycategory" id="actionsdisplay"></div>

      <!-- Build Code Display -->
      <div class="masterycategory" id="buildcodedisplay">
        <div class="build-sharing">
          <div class="share-options">
            <div class="share-option">
              <label>Build URL:</label>
              <textarea id="build-url" readonly onclick="this.select()"></textarea>
              <button class="copy-button" data-target="build-url">Copy</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="button-container">
      <div class="button" id="back-button">< Select Actions</div>
      <div class="button" id="new-build-button">Create New Build</div>
      <div class="button" id="edit-build-button">Edit This Build</div>
    </div>
  </div>

  <div id="copyright">
    <span class="cpr">TS2 Builder <span class="version">v2.0</span> Â© 2016-2024 Team Terrasphere</span>
    <span class="cpr">All visuals and music belong to their respective owners.</span>
  </div>

  <script>
    // Build Sheet Display Logic
    class BuildSheet {
      constructor() {
        this.state = window.buildState;
        this.dataLoader = window.DataLoader;
        this.domUtils = window.DOMUtils;
        this.calculations = window.CharacterCalculations;
        this.buildEncoder = window.BuildEncoder;
        
        this.armorImages = {
          heavy: 'https://terrarp.com/db/tool/armor-heavy.png',
          medium: 'https://terrarp.com/db/tool/armor-medium.png',
          light: 'https://terrarp.com/db/tool/armor-light.png'
        };
        
        this.rankLabels = ['E', 'D', 'C', 'B', 'A', 'S'];
        
        this.init();
      }
      
      init() {
        try {
          // Show the build display (it's hidden by default in app.css)
          const buildDisplay = this.domUtils.getElementById('builddisplay');
          if (buildDisplay) {
            buildDisplay.style.display = 'block';
          }
          
          // Load data
          this.dataLoader.loadAll();
          
          // Load state from URL if present
          this.state.loadFromURL();
          
          // Check for build code in URL hash
          this.loadFromBuildCode();
          
          // Check if we have a complete build
          if (!this.state.isValidForBuildSheet()) {
            alert('Please complete all previous steps first.');
            window.location.href = this.state.generateURL('mastery-selector.html');
            return;
          }
          
          // Calculate and display everything
          this.displayBuild();
          
          // Set up event listeners
          this.setupEventListeners();
          
        } catch (error) {
          console.error('Failed to initialize build sheet:', error);
          this.showError('Failed to load build data. Please refresh the page.');
        }
      }
      
      loadFromBuildCode() {
        const hash = window.location.hash;
        if (hash && (hash.includes('#load.') || hash.includes('#import.') || hash.includes('#sample.'))) {
          const result = this.buildEncoder.loadFromURL();
          if (result.success) {
            this.state.updateState(result.data);
          }
        }
      }
      
      displayBuild() {
        const currentState = this.state.getState();
        const masteries = this.dataLoader.cache.masteries;
        const actions = this.dataLoader.cache.actions;
        
        // Display character name and banner
        this.displayCharacterName(currentState.characterName);
        this.displayBanner(currentState);

        console.log(currentState)
        this.displayCharacterRace(currentState.characterRace);
        
        // Display masteries
        this.displayMasteries(currentState, masteries);
        
        // Calculate and display stats
        const stats = this.calculations.getCompleteStats(currentState, masteries, actions);
        this.displayStats(stats);
        
        // Display equipment
        this.displayEquipment(currentState);
        
        // Display actions
        this.displayActions(currentState, actions);
        
        // Generate build codes
        this.generateBuildCodes(currentState);
        
        // Replace character name in all roll codes
        this.replaceCharacterName(currentState.characterName);
        
        // Replace weapon rank (WR) in all roll codes
        this.replaceWeaponRank(currentState.weaponRank);
        
        // Set up thread code functionality
        this.setupThreadCode();
        
        // Hide navigation for imported characters
        this.adjustNavigationForImportedCharacter();
      }
      
      displayCharacterName(name) {
        const displayName = name || 'Character Build';
        this.domUtils.setText(this.domUtils.getElementById('character-name-display'), displayName);
      }

      displayCharacterRace(race) {
        const displayRace = race || 'Character Race';
        this.domUtils.setText(this.domUtils.getElementById('character-race-display'), displayRace);
      }
      
      displayBanner(state) {
        const bannerContainer = this.domUtils.getElementsByClassName('banner')[0];
        if (!bannerContainer) return;
        
        if (state.profileBannerUrl) {
          // Show character banner if available
          bannerContainer.style.display = 'flex';
          bannerContainer.innerHTML = `<div class='charbanner' style='background-image: url(${state.profileBannerUrl})'></div>`;
        } else {
          // Hide banner if no image
          bannerContainer.style.height = '0px';
          bannerContainer.style.display = 'none';
        }
      }
      
      displayMasteries(state, masteries) {
        const container = this.domUtils.getElementById('masterydisplay');
        let html = '';
        
        state.chosenMasteries.forEach((masteryId, index) => {
          const mastery = masteries.find(m => m.lookup === masteryId);
          const rank = state.chosenMasteriesRanks[index] || 0;
          
          if (mastery) {
            html += `
              <div class="masterydisplay">
                <div class="displaycircle ${mastery.lookup}">
                  <img src="${mastery.image}">
                </div>
                <div class="displaytitle">${mastery.name}</div>
                <div class="displayrank">${this.rankLabels[rank]}</div>
              </div>
            `;
          }
        });
        
        this.domUtils.setHTML(container, html);
      }
      
      displayStats(stats) {
        // HP
        this.domUtils.appendHTML(
          this.domUtils.querySelector('.hpcontainer'), 
          `<div>${stats.hp}</div>`
        );
        
        // Movement
        this.domUtils.appendHTML(
          this.domUtils.querySelector('.movementcontainer'),
          `<div>${stats.movement}</div>`
        );
        
        // Range (if > 0)
        if (stats.range > 0) {
          this.domUtils.appendHTML(
            this.domUtils.querySelector('.rangecontainer'),
            `<div>${stats.range}</div>`
          );
          this.domUtils.show(this.domUtils.querySelector('.rangecontainer'));
        }
        
        // Saves
        this.domUtils.setText(this.domUtils.getElementById('fortitudesave'), '+' + stats.saves.fortitude);
        this.domUtils.setText(this.domUtils.getElementById('reflexsave'), '+' + stats.saves.reflex);
        this.domUtils.setText(this.domUtils.getElementById('willsave'), '+' + stats.saves.will);
        
        // Expertise
        this.domUtils.setText(this.domUtils.getElementById('skillfitness'), '+' + stats.expertise.fitness);
        this.domUtils.setText(this.domUtils.getElementById('skillknack'), '+' + stats.expertise.knack);
        this.domUtils.setText(this.domUtils.getElementById('skillawareness'), '+' + stats.expertise.awareness);
        this.domUtils.setText(this.domUtils.getElementById('skillknowledge'), '+' + stats.expertise.knowledge);
        this.domUtils.setText(this.domUtils.getElementById('skillpresence'), '+' + stats.expertise.presence);
      }
      
      displayEquipment(state) {
        const { armorType, weaponRank, armorRank } = state;

        this.domUtils.setHTML(
          this.domUtils.querySelector('.weaponrankdisplay'),
          `<div class="displaycircle equipment"><img src="https://terrarp.com/db/tool/weapon-rank.png"></div><div class="displaytitle">Weapon</div><div class="displayrank">${this.rankLabels[weaponRank]}</div>`
        );

        if (armorType && this.armorImages[armorType]) {
          this.domUtils.setHTML(
            this.domUtils.querySelector('.armorrankdisplay'),
            `<div class="displaycircle equipment"><img id="armordisplay" src="${this.armorImages[armorType]}"></div><div class="displaytitle"><span id="aweight">${armorType.charAt(0).toUpperCase() + armorType.slice(1)} </span>Armor</div><div class="displayrank">${this.rankLabels[armorRank]}</div>`
          );
          
          // Set armor ability
          const armorAbilityData = this.getArmorAbility(armorType, armorRank);
          this.displayArmorAbility(armorAbilityData, armorType, armorRank);
        }
        
        // Populate mastery check icons
        this.populateMasteryCheckIcons(state);
      }
      
      getArmorAbility(armorType, armorRank) {
        if (!window.armorAbilities) return { name: 'No ability', description: '', rollCode: '' };
        
        const rankLetter = this.rankLabels[armorRank];
        return window.armorAbilities[armorType]?.[rankLetter] || { name: 'No ability', description: '', rollCode: '' };
      }

      displayArmorAbility(abilityData, armorType, armorRank) {
        const container = this.domUtils.querySelector('.passivecontainer');
        const armorSkillDisplay = container.closest('#equipmentdisplay');
        
        if (!abilityData.name || abilityData.name === 'No ability' || armorRank === 0) {
          container.innerHTML = '<span class="armorpassive"></span>';
          // Hide the entire armor skill display div when no armor ability
          if (armorSkillDisplay) {
            armorSkillDisplay.style.display = 'none';
          }
          return;
        }

        // Show the armor skill display div when there is an ability
        if (armorSkillDisplay) {
          armorSkillDisplay.style.display = 'block';
        }

        const armorTypeName = armorType.charAt(0).toUpperCase() + armorType.slice(1);
        
        container.innerHTML = `
          <span class="armorpassive"></span>
          <p><b>${abilityData.name}.</b> (${armorTypeName} Armor Ability)</p>
          <p>${abilityData.description}</p>
          <p><u class="charpassive">${abilityData.rollCode}</u></p>
        `;
      }
      
      populateMasteryCheckIcons(state) {
        const container = this.domUtils.getElementById('masterycheckicons');
        const masteries = this.dataLoader.cache.masteries;
        let html = '';
        
        state.chosenMasteries.forEach(masteryId => {
          const mastery = masteries.find(m => m.lookup === masteryId);
          if (mastery) {
            html += `<div class='display masterycircle ${mastery.lookup}' onclick='clickMastery(this)'><img src='${mastery.image}'></div>`;
          }
        });
        
        this.domUtils.setHTML(container, html);
      }
      
      displayActions(state, actions) {
        const container = this.domUtils.getElementById('actionsdisplay');
        const masteries = this.dataLoader.cache.masteries;
        let html = '';
        
        // Add base actions first (attack, recover, rush)
        this.displayBaseActions(state, masteries);
        
        // Add chosen actions
        state.chosenActions.forEach(actionId => {
          const action = actions.find(a => a.lookup === actionId);
          if (action && !['attack', 'recover', 'rush'].includes(action.lookup)) {
            html += this.generateActionCard(action, state, masteries);
          }
        });
        
        this.domUtils.setHTML(container, html);
      }
      
      displayBaseActions(state, masteries) {
        const baseActions = ['attack', 'recover', 'rush'];
        const actions = this.dataLoader.cache.actions;
        
        baseActions.forEach(actionId => {
          const action = actions.find(a => a.lookup === actionId);
          if (action) {
            const container = this.domUtils.querySelector(`.card.${actionId}`);
            if (container) {
              this.domUtils.setHTML(container, this.generateActionCardContent(action, state, masteries));
            }
          }
        });
      }
      
      generateActionCard(action, state, masteries) {
        return `<div class="card" id="${action.lookup}final" style="border-color: ${action.color}">
          ${this.generateActionCardContent(action, state, masteries)}
        </div>`;
      }
      
      generateActionCardContent(action, state, masteries) {
        const rollSection = action.dice && action.dice !== '-' ? 
          `<div class="cardroll"><b>Roll:</b> ${action.dice}</div>` : '';
        
        const rollCodeSection = action.roll && action.roll !== '-' ? 
          `<div class="rollcode">${action.roll}</div>` : '';
        
        // Generate mastery icons for this action
        const masteryIcons = this.generateMasteryIcons(action, state, masteries);
        
        return `
          <div class="cardicon aci-${action.lookup}" style="background-color: ${action.color}"></div>
          <div class="cardtitle">${action.name}</div>
          <div class="cardinfo">${action.description}</div>
          ${rollSection}
          ${rollCodeSection}
          ${masteryIcons}
        `;
      }
      
      generateMasteryIcons(action, state, masteries) {
        if (!action.masteries) return '';
        
        const actionMasteries = action.masteries.split(' ');
        const applicableMasteries = state.chosenMasteries.filter(masteryId => 
          actionMasteries.includes(masteryId)
        );
        
        if (applicableMasteries.length === 0) return '';
        
        let html = '<div class="masteryicon">';
        applicableMasteries.forEach(masteryId => {
          const mastery = masteries.find(m => m.lookup === masteryId);
          if (mastery) {
            html += `<div class="display masterycircle ${masteryId}"><img onclick="clickMastery(this)" class="${masteryId}" src="${mastery.image}"></div>`;
          }
        });
        html += '</div>';
        
        return html;
      }
      
      generateBuildCodes(state) {
        // Generate main build URL
        const buildURL = this.buildEncoder.generateBuildCode(state);
        this.domUtils.setValue(this.domUtils.getElementById('build-url'), buildURL);
      }
      
      replaceCharacterName(characterName) {
        if (!characterName) return;
        
        // Replace in all sections that contain roll codes
        const sectionsToUpdate = [
          'freeactiondisplay',
          'actionsdisplay', 
          'saveschecks'
        ];
        
        sectionsToUpdate.forEach(sectionId => {
          const section = this.domUtils.getElementById(sectionId);
          if (section) {
            section.innerHTML = section.innerHTML.replace(/Character Name/g, characterName);
          }
        });
        
        // Replace in armor passive if it exists
        const armorPassive = this.domUtils.querySelector('.charpassive');
        if (armorPassive) {
          armorPassive.innerHTML = armorPassive.innerHTML.replace(/Character Name/g, characterName);
        }
        
        // Update character name display
        const charNameElement = this.domUtils.querySelector('.charname');
        if (charNameElement) {
          charNameElement.innerHTML = characterName;
        }
      }
      
      replaceWeaponRank(weaponRank) {
        if (weaponRank === undefined || weaponRank === null) return;
        
        // Convert weapon rank number to letter
        const rankLetters = ['E', 'D', 'C', 'B', 'A', 'S'];
        const weaponRankLetter = rankLetters[weaponRank] || 'E';
        
        // Replace in all sections that contain roll codes
        const sectionsToUpdate = [
          'freeactiondisplay',
          'actionsdisplay', 
          'saveschecks'
        ];
        
        sectionsToUpdate.forEach(sectionId => {
          const section = this.domUtils.getElementById(sectionId);
          if (section) {
            section.innerHTML = section.innerHTML.replace(/WR/g, weaponRankLetter);
          }
        });
        
        // Replace in armor passive if it exists
        const armorPassive = this.domUtils.querySelector('.charpassive');
        if (armorPassive) {
          armorPassive.innerHTML = armorPassive.innerHTML.replace(/WR/g, weaponRankLetter);
        }
      }
      
      setupThreadCode() {
        this.domUtils.addEventListener(
          this.domUtils.getElementById('thrcodebutton'),
          'click',
          () => this.updateThreadCode()
        );
      }
      
      updateThreadCode() {
        const newCode = this.domUtils.getValue(this.domUtils.getElementById('threadcodereplace'));
        const elements = this.domUtils.querySelectorAll('.thrcode');
        
        elements.forEach(element => {
          this.domUtils.setText(element, newCode || 'Thread Code');
        });
      }
      
      setupEventListeners() {
        // Copy buttons
        this.domUtils.querySelectorAll('.copy-button').forEach(button => {
          this.domUtils.addEventListener(button, 'click', (e) => {
            const targetId = e.target.dataset.target;
            const textarea = this.domUtils.getElementById(targetId);
            if (textarea) {
              textarea.select();
              document.execCommand('copy');
              e.target.textContent = 'Copied!';
              setTimeout(() => {
                e.target.textContent = 'Copy';
              }, 2000);
            }
          });
        });
        
        // Navigation buttons
        this.domUtils.addEventListener(
          this.domUtils.getElementById('back-button'),
          'click',
          () => this.goToPreviousPage()
        );
        
        this.domUtils.addEventListener(
          this.domUtils.getElementById('new-build-button'),
          'click',
          () => this.createNewBuild()
        );
        
        this.domUtils.addEventListener(
          this.domUtils.getElementById('edit-build-button'),
          'click',
          () => this.editBuild()
        );
      }
      
      goToPreviousPage() {
        const url = this.state.generateURL('action-selector.html');
        window.location.href = url;
      }
      
      createNewBuild() {
        if (confirm('Are you sure you want to create a new build? This will clear your current progress.')) {
          this.state.reset();
          window.location.href = 'mastery-selector.html';
        }
      }
      
      editBuild() {
        const currentState = this.state.getState();
        
        // If character was imported from Terrarp, skip to action selection
        // since masteries and ranks are already set from the API
        if (currentState.profileBannerUrl) {
          const url = this.state.generateURL('action-selector.html');
          window.location.href = url;
        } else {
          // For manual builds, go back to mastery selection
          const url = this.state.generateURL('mastery-selector.html');
          window.location.href = url;
        }
      }
      
      adjustNavigationForImportedCharacter() {
        const currentState = this.state.getState();
        
        // If character has profileBannerUrl, it was imported from Terrarp
        if (currentState.profileBannerUrl) {
          // Hide "< Select Actions" button
          const backButton = this.domUtils.getElementById('back-button');
          if (backButton) {
            backButton.style.display = 'none';
          }
          
          // Hide "Create New Build" button  
          const newBuildButton = this.domUtils.getElementById('new-build-button');
          if (newBuildButton) {
            newBuildButton.style.display = 'none';
          }
        } else {
          // For manual builds (no banner), add top padding to prevent cut-off appearance
          const builddisplay = this.domUtils.getElementById('builddisplay');
          if (builddisplay) {
            builddisplay.style.paddingTop = '60px';
          }
        }
      }
      
      showError(message) {
        const container = this.domUtils.getElementById('builddisplay');
        this.domUtils.showError(container, message);
      }
    }
    
    // Global reference to BuildSheet instance
    let buildSheetInstance = null;
    
    // Global click functions for roll code interaction
    function clickMastery(element) {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      
      // Find the mastery ID from the element's class
      const classList = element.classList.toString();
      console.log('Clicked mastery classList:', classList);
      
      // The classList might contain multiple classes, need to find the mastery one
      const classArray = classList.split(' ');
      let masteryId = null;
      let masteryIndex = -1;
      
      // Find which class corresponds to a chosen mastery
      for (const className of classArray) {
        masteryIndex = state.chosenMasteries.indexOf(className);
        if (masteryIndex !== -1) {
          masteryId = className;
          break;
        }
      }
      
      console.log('Found masteryId:', masteryId, 'at index:', masteryIndex);
      
      if (masteryIndex !== -1) {
        // Get rank letter
        const rankLetters = ['E', 'D', 'C', 'B', 'A', 'S'];
        const rankLetter = rankLetters[state.chosenMasteriesRanks[masteryIndex]];
        
        // Find mastery name
        const mastery = masteries.find(m => m.lookup === masteryId);
        const masteryName = mastery ? mastery.name : 'Mastery';
        
        console.log('Mastery:', mastery, 'Rank:', rankLetter, 'Name:', masteryName);
        
        // Find the roll code container and update
        const cardElement = element.closest('.card');
        if (cardElement) {
          const rollCodeElement = cardElement.querySelector('.rollcode');
          const masteryReplace = cardElement.querySelector('.masteryreplace');
          const mnameReplace = cardElement.querySelector('.mnamereplace');
          
          console.log('Found elements:', { rollCodeElement, masteryReplace, mnameReplace });
          console.log('Full rollCode HTML before changes:', rollCodeElement ? rollCodeElement.innerHTML : 'null');
          
          // Update the spans FIRST, then update the command
          if (masteryReplace) {
            console.log('masteryReplace element before:', masteryReplace.innerHTML);
            masteryReplace.innerHTML = rankLetter;
            console.log('masteryReplace element after:', masteryReplace.innerHTML);
            console.log('Set mastery rank to:', rankLetter);
          } else {
            console.log('masteryReplace element not found');
          }
          if (mnameReplace) {
            console.log('mnameReplace element before:', mnameReplace.innerHTML);
            mnameReplace.innerHTML = masteryName;
            console.log('mnameReplace element after:', mnameReplace.innerHTML);
            console.log('Set mastery name to:', masteryName);
          } else {
            console.log('mnameReplace element not found');
          }
          
          // Don't replace command names - mastery check should stay "?r mastery"
          // Only the rank (MR) and mastery name (Type) get updated
          
          console.log('Full rollCode HTML after all changes:', rollCodeElement ? rollCodeElement.innerHTML : 'null');
        }
      }
    }
    
    function clickFortitude() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, []);
      
      document.querySelector('.savereplace').innerHTML = 'Fortitude';
      document.querySelector('.savebonusreplace').innerHTML = stats.saves.fortitude;
      document.querySelector('.reflexmodifiers').innerHTML = '';
    }
    
    function clickReflex() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, []);
      
      document.querySelector('.savereplace').innerHTML = 'Reflex';
      document.querySelector('.savebonusreplace').innerHTML = stats.saves.reflex;
      document.querySelector('.reflexmodifiers').innerHTML = stats.saves.reflexmod || '';
    }
    
    function clickWill() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, []);
      
      document.querySelector('.savereplace').innerHTML = 'Will';
      document.querySelector('.savebonusreplace').innerHTML = stats.saves.will;
      document.querySelector('.reflexmodifiers').innerHTML = '';
    }
    
    function clickFitness() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, []);
      
      document.querySelector('.expertisereplace').innerHTML = 'Fitness';
      document.querySelector('.expertisebonusreplace').innerHTML = stats.expertise.fitness;
    }
    
    function clickKnack() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, []);
      
      document.querySelector('.expertisereplace').innerHTML = 'Knack';
      document.querySelector('.expertisebonusreplace').innerHTML = stats.expertise.knack;
    }
    
    function clickAwareness() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, []);
      
      document.querySelector('.expertisereplace').innerHTML = 'Awareness';
      document.querySelector('.expertisebonusreplace').innerHTML = stats.expertise.awareness;
    }
    
    function clickKnowledge() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, []);
      
      document.querySelector('.expertisereplace').innerHTML = 'Knowledge';
      document.querySelector('.expertisebonusreplace').innerHTML = stats.expertise.knowledge;
    }
    
    function clickPresence() {
      if (!buildSheetInstance) return;
      
      const state = buildSheetInstance.state.getState();
      const masteries = buildSheetInstance.dataLoader.cache.masteries;
      const stats = buildSheetInstance.calculations.getCompleteStats(state, masteries, []);
      
      document.querySelector('.expertisereplace').innerHTML = 'Presence';
      document.querySelector('.expertisebonusreplace').innerHTML = stats.expertise.presence;
    }
    
    // Advantage/disadvantage toggle functions for saves
    function advantageSave() {
      document.querySelector('.saveadv').innerHTML = 'adv ';
    }
    
    function normalSave() {
      document.querySelector('.saveadv').innerHTML = '';
    }
    
    function disadvantageSave() {
      document.querySelector('.saveadv').innerHTML = 'dis ';
    }
    
    // Advantage/disadvantage toggle functions for expertise
    function advantageExpertise() {
      document.querySelector('.expertiseadv').innerHTML = 'adv ';
    }
    
    function normalExpertise() {
      document.querySelector('.expertiseadv').innerHTML = '';
    }
    
    function disadvantageExpertise() {
      document.querySelector('.expertiseadv').innerHTML = 'dis ';
    }
    
    // Advantage/disadvantage toggle functions for mastery
    function advantageMastery() {
      document.querySelector('.masteryadv').innerHTML = 'adv ';
    }
    
    function normalMastery() {
      document.querySelector('.masteryadv').innerHTML = '';
    }
    
    function disadvantageMastery() {
      document.querySelector('.masteryadv').innerHTML = 'dis ';
    }
    
    // Initialize when page loads - use window.onload for data loading
    window.onload = function() {
      buildSheetInstance = new BuildSheet();
    };
  </script>

  <style>
    .build-sharing {
      background-color: #23293775;
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
    }

    .share-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .share-option {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .share-option label {
      font-weight: bold;
      color: #FFF;
    }

    .share-option textarea {
      min-height: 60px;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
    }

    .copy-button {
      align-self: flex-start;
      padding: 6px 12px;
      background-color: #a9357b;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .copy-button:hover {
      background-color: #a9357b;
    }

    .displaytitle {
      font-weight: bold;
      margin-bottom: 4px;
    }
  </style>
</body>
</html>